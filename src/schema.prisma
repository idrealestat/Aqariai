// ============================================
// NOVA CRM - Complete Prisma Schema
// ============================================
// 27 Tables | All Relations | Complete Enums
// Ready for Production
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  phone     String   @unique
  password  String
  name      String
  role      UserRole @default(BROKER)
  status    UserStatus @default(ACTIVE)
  
  emailVerified Boolean @default(false)
  phoneVerified Boolean @default(false)
  
  // Profile
  companyName            String?
  falLicense             String?
  falExpiry              DateTime?
  commercialRegistration String?
  commercialExpiry       DateTime?
  idNumber               String?
  dateOfBirth            DateTime?
  city                   String?
  district               String?
  bio                    String?
  avatarUrl              String?
  coverImageUrl          String?
  logoImageUrl           String?
  
  // Business Card
  websiteUrl     String?
  officeLocation String?
  googleMapsUrl  String?
  level          UserLevel @default(STARTER)
  
  // Social Media
  socialLinks Json? // {instagram, twitter, snapchat, tiktok, linkedin, youtube}
  
  // Settings
  preferences          Json? // {language, theme, notifications}
  notificationSettings Json? // {email, push, sms, dnd}
  
  // Working Hours
  workingHours Json? // [{day: 0-6, isWorking, startTime, endTime, breakStart, breakEnd}]
  
  // Timestamps
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  lastLogin  DateTime?
  
  // Relations
  subscription       Subscription?
  customers          Customer[]
  properties         Property[]
  offers             Offer[]
  requests           Request[]
  smartMatches       SmartMatch[]
  appointments       Appointment[]
  tasks              Task[]
  tasksAssigned      Task[] @relation("AssignedTasks")
  teamMemberships    TeamMember[]
  managedTeams       Team[]
  notifications      Notification[]
  otpCodes           OtpCode[]
  analyticsEvents    AnalyticsEvent[]
  userStats          UserStats?
  holidays           Holiday[]
  
  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([status])
  @@map("users")
}

enum UserRole {
  BROKER
  TEAM_MEMBER
  MANAGER
  COMPANY
  OWNER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum UserLevel {
  STARTER
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

model OtpCode {
  id        String   @id @default(uuid())
  userId    String
  code      String
  type      OtpType
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([code])
  @@map("otp_codes")
}

enum OtpType {
  EMAIL_VERIFICATION
  PHONE_VERIFICATION
  PASSWORD_RESET
}

// ============================================
// SUBSCRIPTIONS
// ============================================

model SubscriptionPlan {
  id            String  @id @default(uuid())
  name          String  @unique // individual, team, office, company
  nameAr        String
  priceMonthly  Int
  priceYearly   Int
  features      Json
  limits        Json // {maxMembers, maxProperties, maxStorageGb, maxPlatforms}
  priorityLevel Int     @default(0)
  isActive      Boolean @default(true)
  createdAt     DateTime @default(now())
  
  subscriptions Subscription[]
  
  @@map("subscription_plans")
}

model Subscription {
  id                 String            @id @default(uuid())
  userId             String            @unique
  planId             String
  status             SubscriptionStatus @default(ACTIVE)
  billingCycle       BillingCycle
  
  trialEndsAt        DateTime?
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAt           DateTime?
  cancelledAt        DateTime?
  
  paymentMethod      Json? // {type, last4, brand}
  lastPaymentAt      DateTime?
  nextPaymentAt      DateTime?
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan SubscriptionPlan @relation(fields: [planId], references: [id])
  
  invoices Invoice[]
  
  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

model Invoice {
  id             String        @id @default(uuid())
  subscriptionId String
  userId         String
  amount         Int
  currency       String        @default("SAR")
  status         InvoiceStatus
  paymentMethod  String?
  transactionId  String?
  invoiceUrl     String?
  createdAt      DateTime      @default(now())
  paidAt         DateTime?
  
  subscription Subscription @relation(fields: [subscriptionId], references: [id])
  
  @@index([userId])
  @@index([status])
  @@map("subscription_invoices")
}

enum InvoiceStatus {
  PAID
  PENDING
  FAILED
  REFUNDED
}

// ============================================
// TEAMS
// ============================================

model Team {
  id          String   @id @default(uuid())
  name        String
  managerId   String
  companyId   String?
  logoUrl     String?
  description String?
  settings    Json? // {allowMemberInvite, requireApproval}
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  manager User         @relation(fields: [managerId], references: [id])
  members TeamMember[]
  
  @@map("teams")
}

model TeamMember {
  id        String           @id @default(uuid())
  teamId    String
  userId    String
  role      TeamMemberRole   @default(MEMBER)
  status    TeamMemberStatus @default(ACTIVE)
  joinedAt  DateTime         @default(now())
  
  team        Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissions TeamPermissions?
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

enum TeamMemberRole {
  MANAGER
  BROKER
  OBSERVER
}

enum TeamMemberStatus {
  ACTIVE
  INACTIVE
}

model TeamPermissions {
  id           String @id @default(uuid())
  teamMemberId String @unique
  permissions  Json // {crm: {view, create, edit, delete}, properties: {...}, ...}
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  
  @@map("permissions")
}

// ============================================
// CRM - CUSTOMERS
// ============================================

model Customer {
  id                     String   @id @default(uuid())
  userId                 String
  teamId                 String?
  assignedTo             String?
  
  name                   String
  phone                  String
  email                  String?
  whatsapp               String?
  idNumber               String?
  
  category               String? // مشتري، بائع، مستأجر، مؤجر، مستثمر
  interestLevel          String? // مهتم جداً، مهتم، محتمل، بارد
  source                 String? // إعلان، إحالة، موقع، معرض
  status                 CustomerStatus @default(ACTIVE)
  isVip                  Boolean  @default(false)
  
  preferredContactMethod String?
  preferredContactTime   Json? // {morning, afternoon, evening}
  
  budgetMin              Int?
  budgetMax              Int?
  financingNeeded        Boolean?
  
  preferredCities        String[]
  preferredDistricts     String[]
  propertyTypes          String[]
  
  tags                   String[]
  notes                  String?
  customFields           Json?
  
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  lastContact            DateTime?
  
  user       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  activities CustomerActivity[]
  documents  CustomerDocument[]
  properties Property[]
  requests   Request[]
  appointments Appointment[]
  tasks      Task[]
  
  @@index([userId])
  @@index([phone])
  @@index([category])
  @@index([interestLevel])
  @@index([tags])
  @@map("customers")
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model CustomerActivity {
  id          String   @id @default(uuid())
  customerId  String
  userId      String?
  type        String // call, message, meeting, email, note, status_change
  description String?
  metadata    Json? // {duration, outcome, nextStep}
  createdAt   DateTime @default(now())
  
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([customerId])
  @@index([type])
  @@map("customer_activities")
}

model CustomerDocument {
  id         String   @id @default(uuid())
  customerId String
  uploadedBy String
  name       String
  type       String? // id, contract, receipt, other
  fileUrl    String
  fileSize   Int?
  mimeType   String?
  createdAt  DateTime @default(now())
  
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@map("customer_documents")
}

// ============================================
// PROPERTIES
// ============================================

model Property {
  id                 String         @id @default(uuid())
  userId             String
  customerId         String?
  
  title              String
  description        String?
  propertyType       String // فيلا، شقة، أرض، محل تجاري
  category           String // سكني، تجاري
  listingType        ListingType
  
  city               String
  district           String
  street             String?
  locationLat        Float?
  locationLng        Float?
  googleMapsUrl      String?
  
  price              Int
  priceNegotiable    Boolean        @default(true)
  commissionPercentage Float?
  
  area               Int
  bedrooms           Int?
  bathrooms          Int?
  lounges            Int?
  floors             Int?
  
  propertyAge        Int?
  deedNumber         String?
  facing             String? // شمالية، جنوبية، شرقية، غربية
  streetWidth        Int?
  
  features           String[] // مسبح، حديقة، مصعد، مواقف
  amenities          String[]
  
  status             PropertyStatus @default(DRAFT)
  isFeatured         Boolean        @default(false)
  isPublished        Boolean        @default(false)
  publishedAt        DateTime?
  
  viewsCount         Int            @default(0)
  inquiriesCount     Int            @default(0)
  sharesCount        Int            @default(0)
  
  customFields       Json?
  source             String? // direct, homeowners, platform
  
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  
  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer Customer?      @relation(fields: [customerId], references: [id])
  images PropertyImage[]
  offers Offer[]
  appointments Appointment[]
  tasks  Task[]
  
  @@index([userId])
  @@index([customerId])
  @@index([propertyType])
  @@index([listingType])
  @@index([city])
  @@index([status])
  @@index([price])
  @@index([area])
  @@map("properties")
}

enum ListingType {
  SALE
  RENT
}

enum PropertyStatus {
  DRAFT
  ACTIVE
  SOLD
  RENTED
  ARCHIVED
}

model PropertyImage {
  id           String   @id @default(uuid())
  propertyId   String
  url          String
  thumbnailUrl String?
  orderIndex   Int      @default(0)
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@index([propertyId])
  @@map("property_images")
}

// ============================================
// OFFERS & REQUESTS
// ============================================

model Offer {
  id            String      @id @default(uuid())
  propertyId    String
  userId        String
  
  summary       Json // Minimal data for marketplace
  fullDetails   Json // Complete data (owner only)
  
  maxBrokers    Int         @default(10)
  acceptedCount Int         @default(0)
  
  status        OfferStatus @default(ACTIVE)
  expiresAt     DateTime?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  property Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  matches  SmartMatch[]
  
  @@index([userId])
  @@index([status])
  @@map("offers")
}

enum OfferStatus {
  ACTIVE
  PAUSED
  COMPLETED
  EXPIRED
}

model Request {
  id              String        @id @default(uuid())
  userId          String
  customerId      String?
  
  type            RequestType
  propertyTypes   String[]
  cities          String[]
  districts       String[]
  
  priceMin        Int?
  priceMax        Int?
  areaMin         Int?
  areaMax         Int?
  
  bedroomsMin     Int?
  bathroomsMin    Int?
  ageMax          Int?
  facing          String?
  
  requiredFeatures String[]
  
  description     String?
  
  financingNeeded Boolean?
  downPayment     Int?
  monthlySalary   Int?
  
  urgencyLevel    String? // urgent, medium, low
  
  status          RequestStatus @default(ACTIVE)
  
  summary         Json?
  fullDetails     Json?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer Customer?     @relation(fields: [customerId], references: [id])
  matches  SmartMatch[]
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@map("requests")
}

enum RequestType {
  BUY
  RENT
}

enum RequestStatus {
  ACTIVE
  FULFILLED
  CANCELED
  ARCHIVED
}

// ============================================
// SMART MATCHES
// ============================================

model SmartMatch {
  id                String          @id @default(uuid())
  offerId           String
  requestId         String
  brokerId          String?
  
  matchScore        Int // 0-100
  matchedFeatures   String[]
  
  status            SmartMatchStatus @default(PENDING)
  
  viewedAt          DateTime?
  acceptedAt        DateTime?
  rejectedAt        DateTime?
  
  algorithmVersion  String?
  calculationData   Json? // {city: 25, district: 20, ...}
  
  createdAt         DateTime         @default(now())
  
  offer   Offer   @relation(fields: [offerId], references: [id], onDelete: Cascade)
  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  broker  User?   @relation(fields: [brokerId], references: [id])
  
  @@unique([offerId, requestId, brokerId])
  @@index([offerId])
  @@index([requestId])
  @@index([brokerId])
  @@index([status])
  @@index([matchScore])
  @@map("smart_matches")
}

enum SmartMatchStatus {
  PENDING
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
}

// ============================================
// CALENDAR & APPOINTMENTS
// ============================================

model Appointment {
  id                  String             @id @default(uuid())
  userId              String
  customerId          String?
  propertyId          String?
  
  title               String
  description         String?
  type                String // معاينة، اجتماع، توقيع عقد، متابعة
  
  startDatetime       DateTime
  endDatetime         DateTime
  duration            Int? // in minutes
  timezone            String             @default("Asia/Riyadh")
  
  location            String?
  googleMapsUrl       String?
  isVirtual           Boolean            @default(false)
  meetingUrl          String?
  
  status              AppointmentStatus  @default(SCHEDULED)
  cancelledReason     String?
  
  reminders           Json? // [{type: "notification", minutesBefore: 30}]
  
  recurrenceRule      Json? // {frequency, interval, endDate}
  parentAppointmentId String?
  
  notes               String?
  
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])
  tasks    Task[]
  
  @@index([userId])
  @@index([customerId])
  @@index([startDatetime])
  @@index([status])
  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

model Holiday {
  id        String   @id @default(uuid())
  userId    String
  name      String?
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("holidays")
}

// ============================================
// TASKS
// ============================================

model Task {
  id          String     @id @default(uuid())
  userId      String
  createdBy   String?
  assignedTo  String?
  
  title       String
  description String?
  type        String? // اتصال، اجتماع، متابعة، مستند، زيارة
  priority    TaskPriority @default(MEDIUM)
  
  dueDate     DateTime?
  dueTime     String?
  
  customerId  String?
  propertyId  String?
  appointmentId String?
  
  status      TaskStatus @default(TODO)
  
  checklist   Json? // [{text, completed}]
  attachments Json? // [{name, url}]
  tags        String[]
  customFields Json?
  
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  user           User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedToUser User? @relation("AssignedTasks", fields: [assignedTo], references: [id])
  customer       Customer? @relation(fields: [customerId], references: [id])
  property       Property? @relation(fields: [propertyId], references: [id])
  appointment    Appointment? @relation(fields: [appointmentId], references: [id])
  comments       TaskComment[]
  
  @@index([userId])
  @@index([assignedTo])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
  CANCELLED
}

model TaskComment {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  comment   String
  createdAt DateTime @default(now())
  
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@map("task_comments")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id                String             @id @default(uuid())
  userId            String
  
  title             String
  message           String
  type              NotificationType
  category          String?
  
  actionUrl         String?
  actionLabel       String?
  
  isRead            Boolean            @default(false)
  readAt            DateTime?
  
  priority          NotificationPriority @default(NORMAL)
  
  relatedEntityType String?
  relatedEntityId   String?
  
  createdAt         DateTime           @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@map("notifications")
}

enum NotificationType {
  APPOINTMENT
  SMART_MATCH
  TASK
  CUSTOMER
  SYSTEM
  TEAM
  SUBSCRIPTION
}

enum NotificationPriority {
  URGENT
  NORMAL
  LOW
}

// ============================================
// ANALYTICS
// ============================================

model AnalyticsEvent {
  id            String   @id @default(uuid())
  userId        String?
  sessionId     String?
  
  eventType     String
  eventCategory String?
  eventAction   String?
  eventLabel    String?
  
  pageUrl       String?
  pageTitle     String?
  referrer      String?
  
  userAgent     String?
  deviceType    String?
  browser       String?
  os            String?
  
  ipAddress     String?
  country       String?
  city          String?
  
  metadata      Json?
  
  createdAt     DateTime @default(now())
  
  user User? @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("analytics_events")
}

model UserStats {
  id                    String   @id @default(uuid())
  userId                String   @unique
  
  totalCustomers        Int      @default(0)
  activeCustomers       Int      @default(0)
  vipCustomers          Int      @default(0)
  
  totalProperties       Int      @default(0)
  activeProperties      Int      @default(0)
  soldProperties        Int      @default(0)
  rentedProperties      Int      @default(0)
  
  totalAppointments     Int      @default(0)
  completedAppointments Int      @default(0)
  cancelledAppointments Int      @default(0)
  
  totalTasks            Int      @default(0)
  completedTasks        Int      @default(0)
  
  totalMatches          Int      @default(0)
  acceptedMatches       Int      @default(0)
  
  totalLogins           Int      @default(0)
  lastActivity          DateTime?
  
  updatedAt             DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id])
  
  @@map("user_stats")
}
